
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pro Patente - App</title>
</head>
<body>

<div class="container">
  <h1>Generador de Patentes</h1>
  <p>Aquí va el contenido visual de tu generador.</p>
</div>
<br><center><button onclick="cerrarSesion()" style="padding:10px 20px;border:none;border-radius:8px;background-color:#f44336;color:white;font-size:16px;cursor:pointer;">Cerrar sesión</button></center><br>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAVbnbZIKNoGwr8xJj9lvkml5QBf5RPTCA",
    authDomain: "propatente.firebaseapp.com",
    projectId: "propatente",
    storageBucket: "propatente.firebasestorage.app",
    messagingSenderId: "514353367543",
    appId: "1:514353367543:web:52e8cd7fa24c8278d906f2",
    measurementId: "G-6VVE5QSDEY"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const tokenLocal = localStorage.getItem("token_sesion");
  const uid = localStorage.getItem("uid");

  onAuthStateChanged(auth, async (user) => {
    if (!user || !uid || !tokenLocal) {
      location.href = "index.html";
      return;
    }

    const userDoc = await getDoc(doc(db, "usuarios", uid));
    if (!userDoc.exists()) {
      location.href = "index.html";
      return;
    }

    const data = userDoc.data();
    if (data.token_sesion !== tokenLocal) {
      alert("Esta cuenta se ha iniciado en otro dispositivo.");
      await cerrarSesion();
    }

    // Verificación periódica de expiración cada 5 minutos
    setInterval(async () => {
      const refreshedDoc = await getDoc(doc(db, "usuarios", uid));
      const fechaExp = refreshedDoc.data().expira.toDate();
      const ahora = new Date();
      if (ahora > fechaExp) {
        alert("Tu licencia ha expirado.");
        await cerrarSesion();
      }
    }, 5 * 60 * 1000);
  });

  async function cerrarSesion() {
    await signOut(auth);
    localStorage.clear();
    location.href = "index.html";
  }
</script>
</body>
</html>
